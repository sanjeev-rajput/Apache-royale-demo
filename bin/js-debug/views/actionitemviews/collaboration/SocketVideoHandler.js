/**
 * Generated by Apache Royale Compiler from views/actionitemviews/collaboration/SocketVideoHandler.as
 * views.actionitemviews.collaboration.SocketVideoHandler
 *
 * @fileoverview
 *
 * @suppress {missingRequire|checkTypes|accessControls}
 */

goog.provide('views.actionitemviews.collaboration.SocketVideoHandler');
/* Royale Dependency List: com.unhurdle.spectrum.Switch,org.apache.royale.jewel.List,org.apache.royale.jewel.VGroup,views.actionitemviews.collaboration.VideoItem,views.actionitemviews.websocket.SocketService,org.apache.royale.utils.Language,XML*/




/**
 * @constructor
 * @param {org.apache.royale.jewel.VGroup} uVidContainer
 * @param {com.unhurdle.spectrum.Switch} shareCamBtn
 * @param {views.actionitemviews.websocket.SocketService} socketService
 */
views.actionitemviews.collaboration.SocketVideoHandler = function(uVidContainer, shareCamBtn, socketService) {
  this.views_actionitemviews_collaboration_SocketVideoHandler_uVidContainer = uVidContainer;
  this.views_actionitemviews_collaboration_SocketVideoHandler_shareCamBtn = shareCamBtn;
  this.views_actionitemviews_collaboration_SocketVideoHandler_socketService = socketService;
  this.views_actionitemviews_collaboration_SocketVideoHandler_peerConnections = {};
};


/**
 * @private
 * @type {string}
 */
views.actionitemviews.collaboration.SocketVideoHandler.prototype.views_actionitemviews_collaboration_SocketVideoHandler_myUserId = null;


/**
 * @private
 * @type {Object}
 */
views.actionitemviews.collaboration.SocketVideoHandler.prototype.views_actionitemviews_collaboration_SocketVideoHandler_peerConnections = null;


/**
 * @private
 * @type {Object}
 */
views.actionitemviews.collaboration.SocketVideoHandler.prototype.views_actionitemviews_collaboration_SocketVideoHandler_localStream = null;


/**
 * @private
 * @type {Object}
 */
views.actionitemviews.collaboration.SocketVideoHandler.prototype.views_actionitemviews_collaboration_SocketVideoHandler_myLocalStream = null;


/**
 * @private
 * @type {boolean}
 */
views.actionitemviews.collaboration.SocketVideoHandler.prototype.views_actionitemviews_collaboration_SocketVideoHandler_webcamInitialized = false;


/**
 * @private
 * @type {org.apache.royale.jewel.VGroup}
 */
views.actionitemviews.collaboration.SocketVideoHandler.prototype.views_actionitemviews_collaboration_SocketVideoHandler_uVidContainer = null;


/**
 * @private
 * @type {com.unhurdle.spectrum.Switch}
 */
views.actionitemviews.collaboration.SocketVideoHandler.prototype.views_actionitemviews_collaboration_SocketVideoHandler_shareCamBtn = null;


/**
 * @private
 * @type {views.actionitemviews.websocket.SocketService}
 */
views.actionitemviews.collaboration.SocketVideoHandler.prototype.views_actionitemviews_collaboration_SocketVideoHandler_socketService = null;


/**
 * @private
 * @type {org.apache.royale.jewel.List}
 */
views.actionitemviews.collaboration.SocketVideoHandler.prototype.views_actionitemviews_collaboration_SocketVideoHandler_userList = null;


/**
 * @param {org.apache.royale.jewel.List} lst
 */
views.actionitemviews.collaboration.SocketVideoHandler.prototype.setUserList = function(lst) {
  this.views_actionitemviews_collaboration_SocketVideoHandler_userList = lst;
};


/**
 * @param {string} id
 */
views.actionitemviews.collaboration.SocketVideoHandler.prototype.setMyUserId = function(id) {
  this.views_actionitemviews_collaboration_SocketVideoHandler_myUserId = id;
};


/**
 */
views.actionitemviews.collaboration.SocketVideoHandler.prototype.onStartWebcam = function() {
  var self = this;
  if (this.views_actionitemviews_collaboration_SocketVideoHandler_webcamInitialized)
    return;
  var /** @type {Object} */ constraints = {"video":true, "audio":false};
  navigator.mediaDevices.getUserMedia(constraints).then(function(stream) {
    self.views_actionitemviews_collaboration_SocketVideoHandler_localStream = stream;
    self.views_actionitemviews_collaboration_SocketVideoHandler_myLocalStream = stream;
    self.views_actionitemviews_collaboration_SocketVideoHandler_webcamInitialized = true;
    self.views_actionitemviews_collaboration_SocketVideoHandler_shareCamBtn.onLabel = "Webcam on";
    self.views_actionitemviews_collaboration_SocketVideoHandler_shareCamBtn.checked = true;
    self.addVideoStream(self.views_actionitemviews_collaboration_SocketVideoHandler_myUserId, stream, true);
    self.views_actionitemviews_collaboration_SocketVideoHandler_socketService.sendToSocket({"type":"share_webcam", "userId":self.views_actionitemviews_collaboration_SocketVideoHandler_myUserId});
  })["catch"](function(err) {
    console.error("Webcam access denied", err);
    self.views_actionitemviews_collaboration_SocketVideoHandler_shareCamBtn.onLabel = "Webcam off";
    self.views_actionitemviews_collaboration_SocketVideoHandler_shareCamBtn.checked = false;
  });
};


/**
 */
views.actionitemviews.collaboration.SocketVideoHandler.prototype.onStopWebcam = function() {
  var self = this;
  if (this.views_actionitemviews_collaboration_SocketVideoHandler_localStream) {
    this.views_actionitemviews_collaboration_SocketVideoHandler_localStream["getTracks"]()["forEach"](function(track) {
      track["stop"]();
    });
    this.views_actionitemviews_collaboration_SocketVideoHandler_localStream = null;
    this.views_actionitemviews_collaboration_SocketVideoHandler_myLocalStream = null;
    this.views_actionitemviews_collaboration_SocketVideoHandler_webcamInitialized = false;
    this.views_actionitemviews_collaboration_SocketVideoHandler_shareCamBtn.checked = false;
    this.views_actionitemviews_collaboration_SocketVideoHandler_shareCamBtn.offLabel = "Webcam off";
  }
  console.log("send disconnect bacl to nod", this.views_actionitemviews_collaboration_SocketVideoHandler_myUserId);
  this.views_actionitemviews_collaboration_SocketVideoHandler_socketService.sendToSocket({"type":"user_disconnected", "userId":this.views_actionitemviews_collaboration_SocketVideoHandler_myUserId});
  for (var /** @type {string} */ id in this.views_actionitemviews_collaboration_SocketVideoHandler_peerConnections) {
    this.views_actionitemviews_collaboration_SocketVideoHandler_peerConnections[id]["close"]();
  }
  this.views_actionitemviews_collaboration_SocketVideoHandler_peerConnections = {};
};


/**
 * @param {string} sender
 * @param {Object} offer
 */
views.actionitemviews.collaboration.SocketVideoHandler.prototype.handleOffer = function(sender, offer) {
  var self = this;
  this.createPeerConnection(sender, false);
  var /** @type {*} */ pc = this.views_actionitemviews_collaboration_SocketVideoHandler_peerConnections[sender];
  pc["setRemoteDescription"](new RTCSessionDescription(offer))["then"](function() {
    return pc["createAnswer"]();
  })["then"](function(answer) {
    pc["setLocalDescription"](answer);
    self.views_actionitemviews_collaboration_SocketVideoHandler_socketService.sendToSocket({"type":"video-answer", "target":sender, "answer":answer});
  })["catch"](function(error) {
    console.error("‚ùå Error handling offer from", sender, ":", error);
  });
};


/**
 * @param {string} sender
 * @param {Object} answer
 */
views.actionitemviews.collaboration.SocketVideoHandler.prototype.handleAnswer = function(sender, answer) {
  this.views_actionitemviews_collaboration_SocketVideoHandler_peerConnections[sender]["setRemoteDescription"](new RTCSessionDescription(answer));
};


/**
 * @param {string} sender
 * @param {Object} candidate
 */
views.actionitemviews.collaboration.SocketVideoHandler.prototype.handleCandidate = function(sender, candidate) {
  this.views_actionitemviews_collaboration_SocketVideoHandler_peerConnections[sender]["addIceCandidate"](new RTCIceCandidate(candidate));
};


/**
 * @param {string} userId
 * @param {boolean} isInitiator
 */
views.actionitemviews.collaboration.SocketVideoHandler.prototype.createPeerConnection = function(userId, isInitiator) {
  var self = this;
  var /** @type {Object} */ config = {"iceServers":[{"urls":"stun:stun.l.google.com:19302"}]};
  var /** @type {*} */ pc = new RTCPeerConnection(config);
  this.views_actionitemviews_collaboration_SocketVideoHandler_peerConnections[userId] = pc;
  this.views_actionitemviews_collaboration_SocketVideoHandler_myLocalStream["getTracks"]()["forEach"](function(track) {
    pc["addTrack"](track, self.views_actionitemviews_collaboration_SocketVideoHandler_myLocalStream);
  });
  pc["onicecandidate"] = function(event) {
    if (event["candidate"]) {
      self.views_actionitemviews_collaboration_SocketVideoHandler_socketService.sendToSocket({"type":"ice-candidate", "target":userId, "candidate":event["candidate"]});
    }
  };
  pc["ontrack"] = function(event) {
    org.apache.royale.utils.Language.trace("üé• Received remote track from", userId);
    self.addVideoStream(userId, event["streams"][0]);
  };
  if (isInitiator) {
    pc["createOffer"]()["then"](function(offer) {
      pc["setLocalDescription"](offer);
      self.views_actionitemviews_collaboration_SocketVideoHandler_socketService.sendToSocket({"type":"video-offer", "target":userId, "offer":offer});
    });
  }
};


/**
 * @param {string} userId
 * @param {Object} stream
 * @param {boolean=} isMe
 */
views.actionitemviews.collaboration.SocketVideoHandler.prototype.addVideoStream = function(userId, stream, isMe) {
  isMe = typeof isMe !== 'undefined' ? isMe : false;
  var foreachiter0_target = this.views_actionitemviews_collaboration_SocketVideoHandler_userList.dataProvider["source"];
  for (var foreachiter0 in foreachiter0_target) 
  {
  var otherId = foreachiter0_target[foreachiter0];
  {
    if (otherId != this.views_actionitemviews_collaboration_SocketVideoHandler_myUserId && !this.views_actionitemviews_collaboration_SocketVideoHandler_peerConnections[otherId]) {
      this.createPeerConnection(otherId, true);
    }
  }}
  
  var /** @type {views.actionitemviews.collaboration.VideoItem} */ vidItem = new views.actionitemviews.collaboration.VideoItem();
  vidItem.videoItemData(userId, stream, isMe);
  this.views_actionitemviews_collaboration_SocketVideoHandler_uVidContainer.addElement(vidItem);
};


/**
 * @param {string} userId
 */
views.actionitemviews.collaboration.SocketVideoHandler.prototype.removePeerVideo = function(userId) {
  for (var /** @type {number} */ i = 0; i < this.views_actionitemviews_collaboration_SocketVideoHandler_uVidContainer.numElements; i++) {
    var /** @type {views.actionitemviews.collaboration.VideoItem} */ vidItem = this.views_actionitemviews_collaboration_SocketVideoHandler_uVidContainer.getElementAt(i);
    if (vidItem && vidItem.userId == userId) {
      this.views_actionitemviews_collaboration_SocketVideoHandler_uVidContainer.removeElement(vidItem);
      break;
    }
  }
  if (this.views_actionitemviews_collaboration_SocketVideoHandler_peerConnections[userId]) {
    this.views_actionitemviews_collaboration_SocketVideoHandler_peerConnections[userId]["close"]();
    delete this.views_actionitemviews_collaboration_SocketVideoHandler_peerConnections[userId];
  }
};


/**
 * Metadata
 *
 * @type {Object.<string, Array.<Object>>}
 */
views.actionitemviews.collaboration.SocketVideoHandler.prototype.ROYALE_CLASS_INFO = { names: [{ name: 'SocketVideoHandler', qName: 'views.actionitemviews.collaboration.SocketVideoHandler', kind: 'class' }] };



/**
 * Reflection
 *
 * @return {Object.<string, Function>}
 */
views.actionitemviews.collaboration.SocketVideoHandler.prototype.ROYALE_REFLECTION_INFO = function () {
  return {
    methods: function () {
      return {
        'SocketVideoHandler': { type: '', declaredBy: 'views.actionitemviews.collaboration.SocketVideoHandler', parameters: function () { return [ 'org.apache.royale.jewel.VGroup', false ,'com.unhurdle.spectrum.Switch', false ,'views.actionitemviews.websocket.SocketService', false ]; }},
        'setUserList': { type: 'void', declaredBy: 'views.actionitemviews.collaboration.SocketVideoHandler', parameters: function () { return [ 'org.apache.royale.jewel.List', false ]; }},
        'setMyUserId': { type: 'void', declaredBy: 'views.actionitemviews.collaboration.SocketVideoHandler', parameters: function () { return [ 'String', false ]; }},
        'onStartWebcam': { type: 'void', declaredBy: 'views.actionitemviews.collaboration.SocketVideoHandler'},
        'onStopWebcam': { type: 'void', declaredBy: 'views.actionitemviews.collaboration.SocketVideoHandler'},
        'handleOffer': { type: 'void', declaredBy: 'views.actionitemviews.collaboration.SocketVideoHandler', parameters: function () { return [ 'String', false ,'Object', false ]; }},
        'handleAnswer': { type: 'void', declaredBy: 'views.actionitemviews.collaboration.SocketVideoHandler', parameters: function () { return [ 'String', false ,'Object', false ]; }},
        'handleCandidate': { type: 'void', declaredBy: 'views.actionitemviews.collaboration.SocketVideoHandler', parameters: function () { return [ 'String', false ,'Object', false ]; }},
        'createPeerConnection': { type: 'void', declaredBy: 'views.actionitemviews.collaboration.SocketVideoHandler', parameters: function () { return [ 'String', false ,'Boolean', false ]; }},
        'addVideoStream': { type: 'void', declaredBy: 'views.actionitemviews.collaboration.SocketVideoHandler', parameters: function () { return [ 'String', false ,'Object', false ,'Boolean', true ]; }},
        'removePeerVideo': { type: 'void', declaredBy: 'views.actionitemviews.collaboration.SocketVideoHandler', parameters: function () { return [ 'String', false ]; }}
      };
    }
  };
};
/**
 * @const
 * @type {number}
 */
views.actionitemviews.collaboration.SocketVideoHandler.prototype.ROYALE_COMPILE_FLAGS = 9;

//# sourceMappingURL=./SocketVideoHandler.js.map
